I"Š<p>avec docker compose on fait de la config avec yaml</p>

<h2 id="complexe-application">complexe application</h2>

<p>si on utilise plusieurs container il est plus simple de les configurer Ã  lâ€™aide dâ€™un fichier docker-compose.yml</p>

<p><img src="/assets/img/docker/dockerCompose.png" alt="docker-compose.yml" /></p>

<p>une fois notre docker-compose configurer on lance la commande <code class="language-plaintext highlighter-rouge">up</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up
</code></pre></div></div>

<p>cette commande va installer lâ€™ensemble de notre stack dÃ©finit dans docker compose</p>

<h2 id="links">â€“links</h2>

<p>pour relier diffÃ©rent container on peut utiliser lâ€™option link</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>redis redis
docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>vote <span class="nt">-p</span> 5000:80 <span class="nt">--link</span> redis:redis voting-app
docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>db postgres:9.4 
docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>result <span class="nt">-p</span> 5001:80 result-app
docker run <span class="nt">-d</span> <span class="nt">--name</span><span class="o">=</span>worker <span class="nt">--link</span> db:db <span class="nt">--link</span> redis:redis worker
</code></pre></div></div>

<p>on peut remarquer que plus gros est notre stack et plus les liens vont Ãªtre compliquer Ã  maintenir</p>

<h3 id="avec-docker-compose">avec docker-compose</h3>

<p>pour le mÃªme stack en utilisant docker-compose.yml</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">redis</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
<span class="na">db</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:9.4</span>
<span class="na">vote</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">voting-app</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">5000:80</span>
  <span class="na">links</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">redis</span>
<span class="na">result</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">result-app</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">5001:80</span>
  <span class="na">links</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">db</span>
<span class="na">worker</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">worker</span>
  <span class="na">links</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">db</span>
    <span class="pi">-</span> <span class="s">redis</span>
</code></pre></div></div>

<p>et pour lancer cette config</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up
</code></pre></div></div>

<p>le fichier docker-compose est beaucoup plus clair et si des changement sont Ã  opÃ©rer, ce sera plus simple</p>

<h2 id="compose---build">compose - build</h2>

<p>on peut utiliser des images de dockerhub dans notre yaml mais Ã©galement des image que lâ€™on a crÃ©Ã© nous mÃªme. Si celle ci ne sont pas encore build, on le prÃ©cise dans notre docker-compose</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">vote</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span> <span class="s">./vote</span>
</code></pre></div></div>

<p>au lien de lâ€™instruction <code class="language-plaintext highlighter-rouge">image</code>, on va utiliser lâ€™instruction <code class="language-plaintext highlighter-rouge">build</code> avec le chemin oÃ¹ se situe notre code.</p>

<p>Maintenant quand on va lancer <code class="language-plaintext highlighter-rouge">docker-composer up</code>, docker va dâ€™abord builder notre image, lui donner un nom temporaire et run un container Ã  partir de cette image.</p>

<h2 id="docker-compose--versions">docker compose -versions</h2>

<p>docker compose Ã  Ã©voluÃ© avec le temps.</p>

<p>pour les versions 2 et suppÃ©rieur, on spÃ©cifie en dÃ©but de fichier la version que lâ€™on utilise</p>

<p><img src="/assets/img/docker/composeVersion.png" alt="compose version" /></p>

<h3 id="with-network">with network</h3>

<p>dans la version 1, docker attache tout les container au rÃ©seau bridge par dÃ©faut. Et les links sont lÃ  pour relier nos diffÃ©rent container.</p>

<p>dans la version 2, docker crÃ©Ã© un rÃ©seau bridge dÃ©diÃ© Ã  cette application et y attache tous les containers. Les containers communique entre eux en utilisant leur service name. les links sont du coup inutile</p>

<h3 id="prioritÃ©-dinstall">prioritÃ© dâ€™install</h3>

<p>Ã  partir de la version 2, on peut spÃ©cifier un ordre dâ€™install en indiquant si un container est dÃ©pendant dâ€™un autre avec <code class="language-plaintext highlighter-rouge">depends_on</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
  <span class="na">vote</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">voting-app</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">redis</span>
</code></pre></div></div>

<p>dans cette exemple docker installera redis avant vote puisque celui-ci dÃ©pend de redis</p>

<h3 id="plusieur-rÃ©seau">plusieur rÃ©seau</h3>

<p>avec la version 2, on peut crÃ©er des rÃ©seau avec docker-compose</p>

<p><img src="/assets/img/docker/ComposeMultipleNetwork.png" alt="compose version" /></p>

<p>dans cette exemple, on relie certain container au rÃ©seau back-end et dâ€™autre au rÃ©seau back-end et front-end. Le container worker devrait lui aussi Ãªtre reliÃ© au rÃ©seau back-end</p>
:ET